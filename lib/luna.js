var npmlog=require("npmlog"),Eof=require("./eof");
(function(){var c=npmlog;c.heading="luna";c.level="http";var k={send:function(a,d,l,k,g){function n(e){f+=e;try{c.verbose("luna#send()","JSON line:",f),b=JSON.parse(f),f="",c.verbose("luna#send()","JSON object:",b),!1===b.returnValue?(h.destroy(),g(Error("luna-send command failed"+(b.errorText?" ("+b.errorText+")":b.errorMessage?" ("+b.errorMessage+")":"")))):k(b,function(a,e){c.verbose("luna#send()","err:",a,"value:",e);if(a||e)c.verbose("luna#send()","closing exec stream"),g(a,e)})}catch(a){}}var m=
a&&a.session,h=new Eof,b;h.pause();d=["luna:/",d.service,d.folder,d.method].join("/");c.verbose("luna#send()","calling:",d+" '"+JSON.stringify(l)+"'");a=a&&a.nReplies?"-n "+a.nReplies+" ":"-i ";m.run(m.getDevice().lunaSend+" "+a+d+" '"+JSON.stringify(l)+"'",h,function(a){(Buffer.isBuffer(a)?a.toString():a).split(/\r?\n/).forEach(n)},process.stderr,function(a){a&&g(a)});var f=""}};"undefined"!==typeof module&&module.exports&&(module.exports=k)})();
