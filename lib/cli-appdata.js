var fs=require("fs"),path=require("path"),mkdirp=require("mkdirp"),async=require("async"),shelljs=require("shelljs"),Validator=require("jsonschema").Validator;
(function(){function b(d,a,c){return c&&"function"===typeof c?a?setImmediate(c,d,a):setImmediate(c,d):d||a}function e(){function d(d){var a={id:"test",type:"array",items:{$ref:"/deviceSchema"}},c=fs.readFileSync(h,"utf8"),b=new Validator;try{var e=JSON.parse(c);b.addSchema(e,"/deviceSchema");return b.validate(d,a)}catch(f){}}var a=path.resolve(process.env.APPDATA||process.env.HOME||process.env.USERPROFILE,".webos");fs.existsSync(a)||mkdirp.sync(a);var c=path.join(__dirname,"json/config.json"),b=path.join(__dirname,
"json/command-service.json"),e=path.join(__dirname,"json/novacom-devices.json"),g=path.join(a,"novacom-devices.json"),h=path.join(__dirname,"schema","NovacomDevices.schema");this.appDataPath=a;this.userConfig=c;this.userDeviceList=g;this.commandServiceData=b;this.commandService=this.deviceList=this.config=null;(function(a,c){if(fs.existsSync(c))try{var b=JSON.parse(fs.readFileSync(c)),e=d(b);if(!e||e&&0<e.errors.length)shelljs.cp("-f",a,c);else{var g=JSON.parse(fs.readFileSync(a)),f=!1,h=b.length;
g.forEach(function(a){f=!1;for(ud in b)b[ud].profile===a.profile&&b[ud].name===a.name&&(f=!0);f||b.push(a)});b.length!==h&&fs.writeFile(c,JSON.stringify(b,null,"\t"))}}catch(k){shelljs.cp("-f",a,c)}else shelljs.cp("-f",a,c)})(e,g)}e.prototype.getPath=function(d){return b(null,this.appDataPath,d)};e.prototype.getAppDir=function(d){return b(null,path.join(__dirname,".."),d)};e.prototype.getConfig=function(d,a){try{if(d||!this.config)this.config=JSON.parse(fs.readFileSync(this.userConfig))}catch(c){return b(c,
this.config,a)}return b(null,this.config,a)};e.prototype.compareProfile=function(b,a){this.getConfig(!1,function(c,e){a(c,b.toLowerCase()===e.profile.toLowerCase())})};e.prototype.compareProfileSync=function(b){this.getConfig(!0);return b.toLowerCase()===this.config.profile.toLowerCase()};e.prototype.getDeviceList=function(d,a){try{if(d||!this.deviceList)this.deviceList=JSON.parse(fs.readFileSync(this.userDeviceList))}catch(c){return b(c,this.deviceList,a)}return b(null,this.deviceList,a)};e.prototype.getCommandService=
function(d){try{this.commandService||(this.commandService=JSON.parse(fs.readFileSync(this.commandServiceData)))}catch(a){return b(a,this.commandService,d)}return b(null,this.commandService,d)};e.prototype.setConfig=function(d,a){try{this.config=d,fs.writeFileSync(this.userConfig,JSON.stringify(this.config,null,"\t"))}catch(c){return b(c,this.config,a)}return b(null,this.config,a)};"undefined"!==typeof module&&module.exports&&(module.exports=e)})();
